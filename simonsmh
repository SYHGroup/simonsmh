#include /var/www/simonsmh/nginxproxy/*;
#systemctl stop nginx && certbot certonly --standalone --email simonsmh@gmail.com -d simonsmh.cc -d app.simonsmh.cc -d www.simonsmh.cc -d blog.simonsmh.cc -d tieba.simonsmh.cc -d bt.simonsmh.cc -d url.simonsmh.cc -d ipv4.simonsmh.cc -d ipv6.simonsmh.cc && systemctl start nginx
#--server https://acme-staging.api.letsencrypt.org/directory

#hsts/ssl certificate settings
ssl_certificate /etc/letsencrypt/live/simonsmh.cc/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/simonsmh.cc/privkey.pem;
add_header Strict-Transport-Security "max-age=10886400;preload";

#default redirect
server {
listen 80 fastopen=64 reuseport;
listen [::]:80 fastopen=64 reuseport;
listen 443 ssl http2 fastopen=64 reuseport;
listen [::]:443 ssl http2 fastopen=64 reuseport;
server_name www.simonsmh.cc blog.simonsmh.cc ipv4.simonsmh.cc ipv6.simonsmh.cc;
return 301 https://simonsmh.cc$request_uri;
#return 301 https://$host$request_uri;
add_header Strict-Transport-Security "";
}

#url redirect usage: [server_name]/?[url]
server {
listen 80;
listen [::]:80;
listen 443 ssl http2;
listen [::]:443 ssl http2;
server_name url.simonsmh.cc;
return 301 $args;
}

#hexo image
server {
listen 80;
listen [::]:80;
server_name simonsmh.cc;
return 301 https://$server_name$request_uri;
add_header Strict-Transport-Security "";
}
server {
listen 443 ssl http2;
listen [::]:443 ssl http2;
server_name simonsmh.cc;
root /var/www/simonsmh.github.io;
}

#defalt app
server {
listen 80;
listen [::]:80;
server_name app.simonsmh.cc;
return 301 https://$server_name$request_uri;
add_header Strict-Transport-Security "";
}
server {
listen 443 ssl http2;
listen [::]:443 ssl http2;
server_name app.simonsmh.cc;
root /var/www/simonsmh; 
index index.php;
#redir to file dir, not using link
location ~ /(files|sfiles)/ {
default_type application/octet-stream;
root /var/wwwfiles/;
}
#Disable upload&run .php files
location ~ ^/(files|sfiles)/.*\.php(\/.*)*$
{
deny all; 
}
#Fix Access-Control-Allow-Origin for glype
location / {
add_header Access-Control-Allow-Origin *;
}
location = /generate_204 {
return 204;
}
location ^~ /shell/ {
proxy_pass http://127.0.0.1:7681/;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
}
location ~ .*\.php(\/.*)*$ {
set $path_info "";
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass unix:/run/php/php7.0-fpm.sock;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param SCRIPT_NAME $fastcgi_script_name;
fastcgi_param PATH_INFO $path_info;
}
location ~* ^.+\.(eot|ttf|otf|woff|svg|woff2)$ {
access_log off;
expires max;
}
error_page  403 /403.php;
error_page  404 /404.php;
}

#tieba
server {
listen 80;
listen [::]:80;
server_name tieba.simonsmh.cc;
return 301 https://$server_name$request_uri;
add_header Strict-Transport-Security "";
}
server {
listen 443 ssl http2;
listen [::]:443 ssl http2;
root /var/www/tieba.simonsmh;
index index.php index.html index.htm;
server_name tieba.simonsmh.cc;
location ~ .*\.php(\/.*)*$ {
set $path_info "";
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass unix:/run/php/php7.0-fpm.sock;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param SCRIPT_NAME $fastcgi_script_name;
fastcgi_param PATH_INFO $path_info;
}
}

#transmission
server {
listen 80;
listen [::]:80;
server_name bt.simonsmh.cc;
return 301 https://$server_name$request_uri;
add_header Strict-Transport-Security "";
}
server {
listen 443 ssl http2;
listen [::]:443 ssl http2;
server_name bt.simonsmh.cc;
location / {
proxy_pass http://127.0.0.1:9091;
proxy_set_header Accept-Encoding "";
proxy_pass_header  X-Transmission-Session-Id;
}
}
